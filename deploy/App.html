<!DOCTYPE html>
<html>
<head>
    <title>Industry Rollup View</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"top",layout:{type:"hbox",align:"fit",padding:10}},{xtype:"container",itemId:"middle",style:{type:"hbox",align:"fit",padding:20,marginBottom:"10px"}},{xtype:"container",itemId:"bottom",style:{type:"hbox",align:"fit",padding:10}}],layout:{type:"vbox",align:"stretch",padding:10},industrySolutionEpicStore:void 0,comboBoxStore:void 0,selectedIndustryEpicID:void 0,selectedIndustryEpicData:void 0,checkBoxCheckedValue:!0,filteredDataForComboBox:void 0,totalAcceptedLeafStoryCount:0,totalLeafStoryCount:0,consolidatedPercentDoneByStoryCount:0,launch:function(){this._loadIndustryEpicDataStore()},_loadIndustryEpicDataStore:function(){this.industrySolutionEpicStore?this.industrySolutionEpicStore.load():this.industrySolutionEpicStore=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Epic",fetch:["Name","State","FormattedID","Owner","Tags","PreliminaryEstimate","c_TargetLaunch"],autoLoad:!0,context:{workspace:"/workspace/1089940415",project:"/project/11656855707",projectScopeUp:!1,projectScopeDown:!0},listeners:{load:function(industrySolutionEpicStore,data,success){this._loadComboBox(),this._loadEpicFilterContainer()},scope:this},sorters:[{property:"FormattedID",direction:"ASC"}]})},_loadComboBox:function(){this.industrySolutionEpicStore&&(this._filterOutIndustrySolutionEpicStoreData(),this._createComboBoxStore(),this.comboBoxStore&&(this.comboBox?(this.comboBox.clearValue(),this.comboBox.bindStore(this.comboBoxStore),this.down("#middle")&&(this.down("#middle").removeAll(!0),this.summaryPanel&&(this.summaryPanel=null)),this.down("#bottom")&&(this.down("#bottom").removeAll(!0),this.rollupViewGrid&&(this.rollupViewGrid=null),this.gridPanel&&(this.gridPanel=null))):(this.comboBox=Ext.create("Ext.form.ComboBox",{fieldLabel:"Select Epics ",itemId:"industryEpicCombobox",store:this.comboBoxStore,queryMode:"local",displayField:"Name",valueField:"ID",triggerAction:"all",width:600,padding:"0 10 0 0",listeners:{select:this._onComboBoxSelect,scope:this}}),this.down("#top").add(this.comboBox))))},_loadEpicFilterContainer:function(){this.filterCheckBox||(this.filterCheckBox=Ext.create('Ext.form. or "On Ramp" or "Assessment" or "Break it Down"field.Checkbox',{renderTo:Ext.getBody(),id:"filterCheckBox",boxLabel:'Exclude all "No Entry" or "Launched" Epics. ',name:"epicFilterCheckBox",inputValue:"PortfolioItems/Epic ",checked:!0,width:250,listeners:{change:function(){console.log("checkbox check change event is fired!"),this.checkBoxCheckedValue=this.down("#filterCheckBox").getValue(),console.log("The checked value is?",this.checkBoxCheckedValue)},scope:this}}),this.down("#top").add(this.filterCheckBox)),this.filterButton||(this.filterButton=Ext.create("Rally.ui.Button",{text:"Filter",renderTo:Ext.getBody(),handler:this._filterButtonClicked,scope:this}),this.down("#top").add(this.filterButton))},_filterButtonClicked:function(){console.log("Filter Button is clicked!"),this.checkBoxCheckedValue=this.down("#filterCheckBox").getValue(),console.log("The checked value is?",this.checkBoxCheckedValue),this._loadIndustryEpicDataStore()},_filterOutIndustrySolutionEpicStoreData:function(){if(this.filteredDataForComboBox=[],this.checkBoxCheckedValue){var epicDataCol=[];Ext.Array.each(this.industrySolutionEpicStore.getRecords(),function(thisIndustryEpic){var epicState=thisIndustryEpic.get("State");if(null!==epicState){var epicStateName=epicState.Name;null!==epicStateName&&"Launched"!==epicStateName&&"Assessment"!==epicStateName&&"On Ramp"!==epicStateName&&"Break it Down"!==epicStateName&&epicDataCol.push(thisIndustryEpic)}}),this.filteredDataForComboBox=epicDataCol}else this.filteredDataForComboBox=this.industrySolutionEpicStore.getRecords()},_onComboBoxSelect:function(){this.selectedIndustryEpicID=this.down("#industryEpicCombobox").getValue(),console.log("Selected value?",this.selectedIndustryEpicID),this._loadSelectedEpicDetailsFromStore(),this._loadGridStore()},_loadSelectedEpicDetailsFromStore:function(){if(this.industrySolutionEpicStore&&this.selectedIndustryEpicID){var records=this.industrySolutionEpicStore.getRecords(),index=this.industrySolutionEpicStore.find("FormattedID",this.selectedIndustryEpicID);this.selectedIndustryEpicData=records[index]}},_createComboBoxStore:function(){if(this.filteredDataForComboBox){Ext.define("Epic",{extend:"Ext.data.Model",fields:[{name:"ID",type:"string"},{name:"Name",type:"string"}]});var epicDataCol=[];Ext.Array.each(this.filteredDataForComboBox,function(thisIndustryEpic){var epicName=thisIndustryEpic.get("Name"),epicId=thisIndustryEpic.get("FormattedID"),epicComboName=epicId+": "+epicName,epicData=Ext.create("Epic",{ID:epicId,Name:epicComboName});epicDataCol.push(epicData)}),this.comboBoxStore=Ext.create("Ext.data.Store",{model:"Epic",data:epicDataCol,autoLoad:!0,listeners:{scope:this}})}},_createGrid:function(){this.rollupViewGrid=Ext.create("Rally.ui.grid.Grid",{store:this.gridStore,columnCfgs:["FormattedID","Name","PercentDoneByStoryCount","Owner","Project","PlannedStartDate","PlannedEndDate","PreliminaryEstimate","State"]}),this.gridPanel=Ext.create("Ext.form.Panel",{renderTo:Ext.getBody(),layout:{type:"vbox",align:"stretch",padding:10},items:[this.rollupViewGrid]}),this.down("#bottom").add(this.gridPanel)},_loadGridStore:function(){console.log("loading grid");var thisFilter={property:"Tags.Name",value:this.selectedIndustryEpicID};this.gridStore?(this.gridStore.setFilter(thisFilter),this.gridStore.load()):this.gridStore=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem",fetch:["Name","Project","State","FormattedID","Owner","Parent","PreliminaryEstimate","Tags","PlannedStartDate","PlannedEndDate","PercentDoneByStoryCount"],autoLoad:!0,context:{workspace:"/workspace/1089940415",project:"/project/11656852180",projectScopeUp:!1,projectScopeDown:!0},filters:[thisFilter],listeners:{load:function(gridStore,data,success){this._loadSummaryPanel(),this.rollupViewGrid||this._createGrid()},scope:this}})},_loadSummaryPanel:function(){this._loadAllEpicDetailsData(),this._loadEpicPercentageDoneData(),this.summaryPanel?(this.summaryPanel.removeAll(!0),this.summaryPanel.add(this.leftContainer,this.rightContainer)):(this.summaryPanel=Ext.create("Ext.form.Panel",{renderTo:Ext.getBody(),width:800,height:175,layout:{type:"hbox",align:"left",padding:10},title:"Epic Summary",items:[this.leftContainer,this.rightContainer]}),this.down("#middle").add(this.summaryPanel))},_loadAllEpicDetailsData:function(){this.leftContainer=Ext.create("Ext.container.Container",{layout:{type:"vbox",align:"left",padding:10},width:500});var epicName="",ownerName="",targetLaunch="";this.selectedIndustryEpicData&&(epicName=this.selectedIndustryEpicData.get("Name"),ownerName=null!==this.selectedIndustryEpicData.get("Owner")?null!==this.selectedIndustryEpicData.get("Owner")._refObjectName?this.selectedIndustryEpicData.get("Owner")._refObjectName:"No Owner":"No Owner",targetLaunch=null!==this.selectedIndustryEpicData.get("c_TargetLaunch")?""+this.selectedIndustryEpicData.get("c_TargetLaunch"):"No Target Specified");var leftItems=[{xtype:"displayfield",fieldLabel:"Name",name:"name",value:epicName},{xtype:"displayfield",fieldLabel:"Owner",name:"owner",value:ownerName},{xtype:"displayfield",fieldLabel:"Target Launch",name:"target_launch",value:targetLaunch}];this.leftContainer.add(leftItems)},_loadEpicPercentageDoneData:function(){if(this.rightContainer=Ext.create("Ext.container.Container",{layout:{type:"vbox",align:"left",padding:10},width:300}),this.progressBarContainer=Ext.create("Ext.container.Container",{layout:{type:"hbox",align:"left",padding:0},width:300}),this.rightContainer.add(this.progressBarContainer),this.gridStore){this._calculateConsolidatedPercentDoneByStoryCount();var progressBarItems=[{xtype:"displayfield",fieldLabel:"Consolidated Percentage Done",name:"percentageDone"},{xtype:"rallypercentdone",fieldLabel:"Consolidated Percentage Done",percentDone:this.consolidatedPercentDoneByStoryCount,width:150}];this.progressBarContainer.add(progressBarItems)}if(this.selectedIndustryEpicData){var preliminaryEstimate="";preliminaryEstimate=this.selectedIndustryEpicData.get("PreliminaryEstimate");var rightItems=[{xtype:"displayfield",fieldLabel:"Preliminary Estimate",name:"preliminary_estimate",value:preliminaryEstimate}];this.rightContainer.add(rightItems)}},_calculateConsolidatedPercentDoneByStoryCount:function(){var records=[];records=this.gridStore.getRecords(),this.totalAcceptedLeafStoryCount=0,this.totalLeafStoryCount=0,Ext.Array.each(records,function(thisRecord){this.totalAcceptedLeafStoryCount=this.totalAcceptedLeafStoryCount+parseInt(thisRecord.get("AcceptedLeafStoryCount")),this.totalLeafStoryCount=this.totalLeafStoryCount+parseInt(thisRecord.get("LeafStoryCount"))},this),this.consolidatedPercentDoneByStoryCount=this.totalAcceptedLeafStoryCount/this.totalLeafStoryCount,console.log("consolidatedPercentDoneByStoryCount : ",this.consolidatedPercentDoneByStoryCount)}});

            Rally.launchApp('CustomApp', {
                name:"Industry Rollup View",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body></body>
</html>
